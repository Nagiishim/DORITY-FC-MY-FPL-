<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DIKE'S FPL — Login</title>
  <style>
    body{font-family:Poppins,Inter,system-ui;background:#07120a;color:#dbeafe;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{background:rgba(255,255,255,0.03);padding:28px;border-radius:12px;width:340px}
    input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none;background:#00ff88;color:#000;font-weight:700;cursor:pointer}
    .muted{color:rgba(255,255,255,0.75);font-size:0.9rem;text-align:center;margin-top:8px}
  </style>
  <!-- Firebase compat libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px 0;color:#00ff88">DIKE'S FPL</h2>
    <input id="email" placeholder="email (or use nagi@local for admin)" />
    <input id="password" placeholder="password" type="password" />
    <button id="btnLogin">Login</button>
    <button id="btnRegister" style="background:#ffd24a">Register</button>
    <div class="muted">Admin: <strong>nagi@local</strong> / <strong>PAIN2358</strong></div>
    <div class="muted">After login you are redirected to the team page.</div>
  </div>

<script>
/* ---------- FIREBASE CONFIG (from you) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCFknCEG0zQjTVpPCs49zm_ERzalXC63Pg",
  authDomain: "dority-fc-site.firebaseapp.com",
  projectId: "dority-fc-site",
  storageBucket: "dority-fc-site.firebasestorage.app",
  messagingSenderId: "388572626223",
  appId: "1:388572626223:web:825dcd942c3056fd3df5da",
  measurementId: "G-FG54ZJ5BRJ"
};
/* ---------- init ---------- */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- auto-create admin (first run) ---------- */
/* Using email nagi@local and password PAIN2358 — creates admin account in Auth if not present.
   NOTE: Firebase Auth requires a valid email format; 'nagi@local' will be created in Auth.
   If you later want a real admin email, register it manually in Firebase Console or change here. */
(async function ensureAdmin(){
  const adminEmail = 'nagi@local';
  const adminPass = 'PAIN2358';
  try {
    // Try to sign in — if exists this will succeed (we then sign out)
    await auth.signInWithEmailAndPassword(adminEmail, adminPass);
    await auth.signOut();
  } catch(e) {
    // If sign-in fails, create the user (register)
    if (e.code === 'auth/user-not-found' || e.message) {
      try {
        await auth.createUserWithEmailAndPassword(adminEmail, adminPass);
        // create a minimal user doc in Firestore
        const uid = auth.currentUser ? auth.currentUser.uid : null;
        if (uid) {
          await db.collection('users').doc(uid).set({ email: adminEmail, team: [], bench: [], totalPoints: 0 });
          await auth.signOut();
        }
      } catch(err){
        // ignore if creation fails due to restrictions; admin can register manually
        console.log('Admin ensure error', err.message);
      }
    }
  }
})();

/* ---------- UI handlers ---------- */
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email || !pass) return alert('Enter email and password');
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    // ensure the user has a Firestore doc
    const u = auth.currentUser;
    const ref = db.collection('users').doc(u.uid);
    const snap = await ref.get();
    if (!snap.exists) {
      await ref.set({ email: u.email, team: [], bench: [], totalPoints: 0 });
    }
    window.location.href = 'team.html';
  } catch(e) {
    alert('Login error: ' + e.message);
  }
});

document.getElementById('btnRegister').addEventListener('click', async ()=>{
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email || !pass) return alert('Enter email and password');
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const uid = cred.user.uid;
    await db.collection('users').doc(uid).set({ email, team: [], bench: [], totalPoints: 0 });
    alert('Registered. You can now log in.');
  } catch(e){
    alert('Register error: ' + e.message);
  }
});

/* If already logged in, go straight to team page */
auth.onAuthStateChanged(user => {
  if (user) {
    window.location.href = 'team.html';
  }
});
</script>
</body>
</html>
