<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DIKE'S FPL — Team</title>
<style>
  :root{--accent:#00ff88}
  *{box-sizing:border-box;font-family:Poppins,Inter,system-ui}
  body{margin:0;background:linear-gradient(180deg,#07120a,#082712);color:#dbeafe;min-height:100vh}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:rgba(255,255,255,0.02)}
  h1{color:var(--accent);margin:0}
  main{max-width:1200px;margin:16px auto;padding:0 16px}
  .layout{display:grid;grid-template-columns:1fr 420px;gap:14px}
  .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  .pitch{background:linear-gradient(180deg,#1f6c33,#0b4b21);padding:18px;border-radius:12px}
  .pitch-row{display:flex;justify-content:center;gap:8px;margin-bottom:10px}
  .slot{min-width:120px;background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;text-align:center}
  .slot.empty{opacity:0.5}
  .pool{height:560px;overflow:auto;padding:8px}
  .pool-item{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-bottom:8px}
  .bench{display:flex;gap:8px;flex-wrap:wrap;padding-top:8px}
  .bench .bench-slot{background:rgba(0,0,0,0.22);padding:8px;border-radius:8px;min-width:110px;text-align:center}
  .muted{color:rgba(255,255,255,0.75);font-size:0.9rem}
  .admin{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:12px}
  @media (max-width:980px){ .layout{grid-template-columns:1fr} }
</style>
<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <h1>DIKE'S FPL — 4-4-2</h1>
  <div id="authArea"></div>
</header>

<main>
  <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center">
    <div class="panel">User: <strong id="me">—</strong></div>
    <div class="panel">Budget left: <strong id="budget">180.0</strong> m€</div>
    <div class="panel">Squad: <strong id="squadCount">0</strong>/15</div>
    <div class="panel">Starting XI: <strong id="startingCount">0</strong>/11</div>
  </div>

  <div class="layout">
    <section>
      <div class="panel pitch">
        <div class="pitch-row" id="gkRow"></div>
        <div class="pitch-row" id="defRow"></div>
        <div class="pitch-row" id="midRow"></div>
        <div class="pitch-row" id="fwdRow"></div>

        <div style="margin-top:12px" class="muted">Bench</div>
        <div class="bench" id="bench"></div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="search" placeholder="Search player..." style="flex:1;padding:8px;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.04)"/>
          <select id="filterPos" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit"><option value="">All</option><option>GK</option><option>DEF</option><option>MID</option><option>FWD</option></select>
        </div>
        <div class="pool" id="pool"></div>
      </div>
    </section>

    <aside>
      <div class="panel">
        <div><strong>Quick actions</strong></div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <button id="btnNextGW">Simulate Next GW (random points) — Admin</button>
          <button id="btnRecalc">Recalculate Totals</button>
          <button id="btnSyncPlayers">Sync players to Firestore (Admin)</button>
        </div>
      </div>

      <div id="adminBox" style="display:none" class="admin">
        <div><strong>Admin — Players (set points)</strong></div>
        <div id="adminPlayers" style="max-height:280px;overflow:auto;margin-top:8px"></div>
        <div style="margin-top:8px"><strong>Signed users</strong><div id="usersList" style="max-height:180px;overflow:auto;margin-top:6px"></div></div>
      </div>
    </aside>
  </div>
</main>

<script>
/* ---------- FIREBASE CONFIG (your values pasted) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCFknCEG0zQjTVpPCs49zm_ERzalXC63Pg",
  authDomain: "dority-fc-site.firebaseapp.com",
  projectId: "dority-fc-site",
  storageBucket: "dority-fc-site.firebasestorage.app",
  messagingSenderId: "388572626223",
  appId: "1:388572626223:web:825dcd942c3056fd3df5da",
  measurementId: "G-FG54ZJ5BRJ"
};
/* admin email list (we use nagi@local as the admin account created earlier) */
const ADMIN_EMAILS = ['nagi@local'];

/* ---------- init firebase ---------- */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- local players list (full) ---------- */
const LOCAL_PLAYERS = [
/* (full list copied from earlier, same as we used previously) */
{ name: "CHIBUIKE SUCCESS", price: 10, pos: "MID" },
{ name: "OKOYE NELSON", price: 9.5, pos: "GK" },
{ name: "NNADOZIE DESTINY", price: 10.5, pos: "GK" },
{ name: "UKONU ANOINTING", price: 15, pos: "DEF" },
{ name: "IBE EMMANUEL", price: 5, pos: "MID" },
{ name: "NWANKWO OSITA", price: 10, pos: "DEF" },
{ name: "JAMES NKWUMAH", price: 5, pos: "MID" },
{ name: "OKONKWO GERARD", price: 5, pos: "DEF" },
{ name: "NNAJI MICHAEL", price: 8, pos: "MID" },
{ name: "IHEANACHO PRAISE", price: 5, pos: "FWD" },
{ name: "CHIAMAEZE OWN", price: 10, pos: "FWD" },
{ name: "EZUEGO ENU", price: 10, pos: "DEF" },
{ name: "MAC DONALD", price: 10, pos: "MID" },
{ name: "OKWUDIRI SOLOMON", price: 10, pos: "DEF" },
{ name: "EKE EMMANUEL", price: 7.5, pos: "MID" },
{ name: "EMOLE JULES", price: 7, pos: "DEF" },
{ name: "NNONA KELVIN", price: 15, pos: "DEF" },
{ name: "EGEMOLE HENRY", price: 10, pos: "DEF" },
{ name: "UZOMA PERFECT", price: 8, pos: "MID" },
{ name: "IBEZUE CHINEDU", price: 8, pos: "MID" },
{ name: "ONUOHA OSCAR", price: 8.5, pos: "DEF" },
{ name: "NNADOZIE DIVINE", price: 10, pos: "GK" },
{ name: "OKOYE VICTOR", price: 11, pos: "MID" },
{ name: "ILLONA PRINCEWILL", price: 11, pos: "MID" },
{ name: "OPARA JOHNSON", price: 12, pos: "DEF" },
{ name: "CHIBUIKE FAITHFUL", price: 8, pos: "MID" },
{ name: "IFEJIAGWA IKECHUKWU", price: 20, pos: "FWD" },
{ name: "ENUKA RAMSEY", price: 4, pos: "MID" },
{ name: "UDOH KENNETH", price: 10, pos: "DEF" },
{ name: "UWANDU DELIGHT", price: 4.5, pos: "MID" },
{ name: "KINGSLEY IBEZUE", price: 10, pos: "FWD" },
{ name: "NDUISI SUCCESS", price: 10, pos: "MID" },
{ name: "EGBE BETHEL", price: 12, pos: "MID" },
{ name: "IGBONACHO SIXTUS", price: 14, pos: "FWD" },
{ name: "JOSEPH PROSPER", price: 10, pos: "DEF" },
{ name: "AUGUSTIN OKECHUKWU", price: 10, pos: "DEF" },
{ name: "OKEZIE DAVID", price: 10, pos: "MID" },
{ name: "ONYEMA VICTOR", price: 10, pos: "FWD" },
{ name: "NWANKWO CHUKWUEMEKA", price: 13, pos: "MID" },
{ name: "MICHAEL ANUDU", price: 10, pos: "MID" },
{ name: "GOODLUCK AMAEFULE", price: 6, pos: "DEF" },
{ name: "CHUKWUMA JUSTIN", price: 13, pos: "FWD" },
{ name: "ONUOHA ISAAC", price: 7, pos: "DEF" },
{ name: "NWACHUKWU MARTINS", price: 11, pos: "MID" },
{ name: "OFOMA RAPHAEL", price: 11, pos: "DEF" },
{ name: "ONUOHA SAMUEL", price: 13, pos: "DEF" },
{ name: "ERNEST KELVIN", price: 9, pos: "MID" },
{ name: "UCHECHRIS PROSPER", price: 12, pos: "FWD" },
{ name: "IHEJI JOSEPH", price: 9, pos: "DEF" },
{ name: "ALABOGU ERNEST", price: 6, pos: "DEF" },
{ name: "MOSES PATRIC", price: 5, pos: "DEF" },
{ name: "DIKE OGBOGU", price: 18, pos: "MID" },
{ name: "EJIKE NOBLE", price: 3, pos: "MID" },
{ name: "DIM OBINNA", price: 3, pos: "DEF" },
{ name: "MIRACLE C", price: 3, pos: "MID" },
{ name: "OKOYE RICHARD", price: 22, pos: "GK" },
{ name: "UKA", price: 8, pos: "DEF" },
{ name: "EMMANUEL VICTOR", price: 6, pos: "FWD" },
{ name: "KALU EKE", price: 21, pos: "FWD" },
{ name: "NNAJI TEMPLE", price: 18, pos: "MID" },
{ name: "OGUERI HENRY", price: 9, pos: "DEF" },
{ name: "KALU JULES", price: 8, pos: "DEF" },
{ name: "ABAYOMI AYOMIDE", price: 25, pos: "FWD" },
{ name: "OKORONKWO AKACHUKWU", price: 25, pos: "FWD" }
];

/* ---------- refs ---------- */
const gkRow = document.getElementById('gkRow');
const defRow = document.getElementById('defRow');
const midRow = document.getElementById('midRow');
const fwdRow = document.getElementById('fwdRow');
const benchEl = document.getElementById('bench');
const poolEl = document.getElementById('pool');
const searchEl = document.getElementById('search');
const filterEl = document.getElementById('filterPos');
const meEl = document.getElementById('me');
const budgetEl = document.getElementById('budget');
const squadCountEl = document.getElementById('squadCount');
const startingCountEl = document.getElementById('startingCount');

const adminBox = document.getElementById('adminBox');
const adminPlayers = document.getElementById('adminPlayers');
const usersList = document.getElementById('usersList');

const playersCol = db.collection('players');
const usersCol = db.collection('users');

/* ---------- auth UI ---------- */
function buildAuthArea(){
  const container = document.getElementById('authArea');
  auth.onAuthStateChanged(user=>{
    container.innerHTML = '';
    if (user) {
      const span = document.createElement('div'); span.textContent = user.email; span.className='muted';
      const btnOut = document.createElement('button'); btnOut.textContent='Logout'; btnOut.onclick = ()=> auth.signOut();
      container.appendChild(span); container.appendChild(btnOut);
      meEl.textContent = user.email;
      // show admin if email matches admin list
      if (ADMIN_EMAILS.includes((user.email||'').toLowerCase())) {
        adminBox.style.display = 'block';
      } else adminBox.style.display = 'none';
      renderAll();
      startRealtime();
    } else {
      const inputEmail = document.createElement('input'); inputEmail.placeholder='email';
      const inputPass = document.createElement('input'); inputPass.type='password'; inputPass.placeholder='password';
      const btnLogin = document.createElement('button'); btnLogin.textContent='Login';
      const btnRegister = document.createElement('button'); btnRegister.textContent='Register';
      btnLogin.onclick = ()=> auth.signInWithEmailAndPassword(inputEmail.value.trim(), inputPass.value.trim()).catch(e=>alert('Login: '+e.message));
      btnRegister.onclick = async ()=> {
        try{
          const cred = await auth.createUserWithEmailAndPassword(inputEmail.value.trim(), inputPass.value.trim());
          await usersCol.doc(cred.user.uid).set({ email: inputEmail.value.trim(), team: [], bench: [], totalPoints: 0 });
          alert('Registered. Now log in.');
        }catch(e){ alert('Register: '+e.message) }
      };
      container.appendChild(inputEmail); container.appendChild(inputPass); container.appendChild(btnLogin); container.appendChild(btnRegister);
    }
  });
}

/* ---------- seed players into Firestore (admin) ---------- */
async function seedPlayers(){
  // batch write LOCAL_PLAYERS into players collection
  const batch = db.batch();
  LOCAL_PLAYERS.forEach(p=>{
    const id = p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-');
    const ref = playersCol.doc(id);
    batch.set(ref, { ...p, points: 0 }, { merge:true });
  });
  await batch.commit();
  alert('Players seeded.');
  loadPlayers();
}

/* ---------- load players from firestore ---------- */
let currentPlayers = [];
async function loadPlayers(){
  const snap = await playersCol.get();
  currentPlayers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderPool();
  renderAdminPlayers();
}

/* ---------- render pool ---------- */
function renderPool(){
  poolEl.innerHTML = '';
  const q = (searchEl.value||'').toLowerCase();
  const posFilter = filterEl.value;
  auth.currentUser && usersCol.doc(auth.currentUser.uid).get().then(async doc=>{
    const data = doc.exists ? doc.data() : { team:[], bench:[] };
    const selected = new Set([...(data.team||[]).map(p=>p.name), ...(data.bench||[]).map(p=>p.name)]);
    currentPlayers.forEach(p=>{
      if (posFilter && p.pos !== posFilter) return;
      if (q && !p.name.toLowerCase().includes(q)) return;
      if (selected.has(p.name)) return;
      const el = document.createElement('div'); el.className='pool-item';
      el.innerHTML = `<div style="display:flex;justify-content:space-between"><strong style="color:var(--accent)">${p.name}</strong><div class="muted">€${p.price.toFixed(1)}m</div></div><div class="muted">${p.pos}</div>`;
      const btn = document.createElement('button'); btn.textContent='Add';
      btn.onclick = ()=> addToUser(p);
      el.appendChild(btn);
      poolEl.appendChild(el);
    });
  }).catch(()=>{ /* not signed in */ });
}

/* ---------- add player to user ---------- */
async function addToUser(player){
  if (!auth.currentUser) return alert('Please login');
  const ref = usersCol.doc(auth.currentUser.uid);
  const snap = await ref.get();
  const data = snap.exists ? snap.data() : { team:[], bench:[] };
  const totalCount = (data.team||[]).length + (data.bench||[]).length;
  if (totalCount >= 15) return alert('Squad full (15)');
  // budget check
  const spent = (data.team||[]).reduce((s,p)=>s+p.price,0) + (data.bench||[]).reduce((s,p)=>s+p.price,0);
  if (INITIAL_BUDGET - spent < player.price) return alert('Not enough budget');
  // duplicate?
  if ((data.team||[]).some(x=>x.name===player.name) || (data.bench||[]).some(x=>x.name===player.name)) return alert('Already selected');
  // place in starting if position slot free
  const posCount = (data.team||[]).filter(x=>x.pos===player.pos).length;
  if (posCount < (player.pos==='GK'?1:(player.pos==='DEF'?4:(player.pos==='MID'?4:2)))) {
    data.team.push({ name: player.name, price: player.price, pos: player.pos });
  } else {
    data.bench = data.bench||[]; data.bench.push({ name: player.name, price: player.price, pos: player.pos });
  }
  await ref.set(data, { merge:true });
  renderAll();
}

/* ---------- remove player ---------- */
async function removeFromUser(name){
  if (!auth.currentUser) return;
  const ref = usersCol.doc(auth.currentUser.uid);
  const snap = await ref.get(); if (!snap.exists) return;
  let data = snap.data();
  data.team = (data.team||[]).filter(p=>p.name!==name);
  data.bench = (data.bench||[]).filter(p=>p.name!==name);
  await ref.set(data, { merge:true });
  renderAll();
}

/* ---------- render pitch and bench ---------- */
async function renderPitchAndBench(){
  gkRow.innerHTML=''; defRow.innerHTML=''; midRow.innerHTML=''; fwdRow.innerHTML=''; benchEl.innerHTML='';
  if (!auth.currentUser) return;
  const snap = await usersCol.doc(auth.currentUser.uid).get();
  const data = snap.exists ? snap.data() : { team:[], bench:[] };
  (data.team||[]).forEach(p=>{
    const el = document.createElement('div'); el.className='slot';
    el.innerHTML = `<div style="font-weight:800;color:var(--accent)">${p.name}</div><div class="muted">${p.pos} • €${p.price.toFixed(1)}m</div><div style="margin-top:8px"><button style="background:transparent;border:1px solid rgba(255,255,255,0.06)" onclick="removeFromUser('${escapeQuotes(p.name)}')">Remove</button></div>`;
    if (p.pos==='GK') gkRow.appendChild(el);
    else if (p.pos==='DEF') defRow.appendChild(el);
    else if (p.pos==='MID') midRow.appendChild(el);
    else fwdRow.appendChild(el);
  });
  (data.bench||[]).forEach(p=>{
    const el = document.createElement('div'); el.className='bench-slot';
    el.innerHTML = `<div style="font-weight:700;color:var(--accent)">${p.name}</div><div class="muted">${p.pos} • €${p.price.toFixed(1)}m</div><div style="margin-top:8px"><button style="background:transparent;border:1px solid rgba(255,255,255,0.06)" onclick="removeFromUser('${escapeQuotes(p.name)}')">Remove</button></div>`;
    benchEl.appendChild(el);
  });

  // update counters & budget
  const countSquad = (data.team||[]).length + (data.bench||[]).length;
  const startingCount = (data.team||[]).length;
  squadCountEl.textContent = countSquad;
  startingCountEl.textContent = startingCount;
  const spent = (data.team||[]).reduce((s,p)=>s+p.price,0) + (data.bench||[]).reduce((s,p)=>s+p.price,0);
  budgetEl.textContent = (INITIAL_BUDGET - spent).toFixed(1);
}

/* ---------- admin UI: players points & users list ---------- */
async function renderAdminPlayers(){
  adminPlayers.innerHTML = '';
  currentPlayers.forEach(p=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px';
    row.innerHTML = `<div><strong style="color:var(--accent)">${p.name}</strong><div class="muted">${p.pos} • €${p.price.toFixed(1)}m</div></div>`;
    const right = document.createElement('div');
    const inp = document.createElement('input'); inp.type='number'; inp.value = p.points || 0; inp.style.width='72px';
    const btn = document.createElement('button'); btn.textContent='Save';
    btn.onclick = async ()=> {
      await playersCol.doc(p.id).set({ ...p, points: Number(inp.value) }, { merge:true });
      await loadPlayers();
      await recalcAllUserTotals();
      alert('Saved points for '+p.name);
    };
    right.appendChild(inp); right.appendChild(btn);
    row.appendChild(right);
    adminPlayers.appendChild(row);
  });
  // users list
  usersList.innerHTML = '';
  const snap = await usersCol.get();
  snap.docs.forEach(d=>{
    const u = d.data();
    const div = document.createElement('div'); div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${u.email||'user'}</strong><div class="muted">Team: ${(u.team||[]).length} Bench: ${(u.bench||[]).length}</div></div><div><button onclick="viewUser('${d.id}')">View</button></div></div>`;
    usersList.appendChild(div);
  });
}

/* ---------- view user (admin helper) ---------- */
window.viewUser = async function(uid){
  const snap = await usersCol.doc(uid).get();
  if (!snap.exists) return alert('No user data');
  const d = snap.data();
  let out = `User: ${d.email||uid}\nTeam:\n`;
  (d.team||[]).forEach(p=> out += ` - ${p.name} ${p.pos} €${p.price}\n`);
  out += 'Bench:\n';
  (d.bench||[]).forEach(p=> out += ` - ${p.name} ${p.pos} €${p.price}\n`);
  alert(out);
}

/* ---------- recalc totals for all users (admin) ---------- */
async function recalcAllUserTotals(){
  const playersSnap = await playersCol.get();
  const pointsMap = {};
  playersSnap.docs.forEach(d=> { const pd = d.data(); pointsMap[pd.name] = pd.points || 0; });
  const usersSnap = await usersCol.get();
  const batch = db.batch();
  usersSnap.docs.forEach(doc=>{
    const d = doc.data();
    const all = [...(d.team||[]), ...(d.bench||[])];
    const totalPoints = all.reduce((sum,p)=> sum + (pointsMap[p.name]||0), 0);
    batch.set(usersCol.doc(doc.id), { totalPoints }, { merge:true });
  });
  await batch.commit();
  alert('Recalculated totals for all users.');
}

/* ---------- simulate random points (admin) ---------- */
document.getElementById('btnNextGW').addEventListener('click', async ()=>{
  if (!auth.currentUser || !ADMIN_EMAILS.includes((auth.currentUser.email||'').toLowerCase())) return alert('Admin only');
  const snap = await playersCol.get();
  const batch = db.batch();
  snap.docs.forEach(d => {
    const pts = Math.floor(Math.random()*8); // random 0-7
    batch.set(d.ref, { points: pts }, { merge:true });
  });
  await batch.commit();
  await loadPlayers();
  await recalcAllUserTotals();
  alert('Simulated random points and updated totals.');
});

/* ---------- helper ---------- */
function escapeQuotes(s){ return s.replace(/'/g,"\\'").replace(/"/g,'\\"'); }

/* ---------- realtime listeners ---------- */
function startRealtime(){
  playersCol.onSnapshot(()=> loadPlayers());
  usersCol.onSnapshot(()=> {
    if (auth.currentUser) renderPitchAndBench();
    if (auth.currentUser && ADMIN_EMAILS.includes((auth.currentUser.email||'').toLowerCase())) renderAdminPlayers();
  });
}

/* ---------- seed if empty ---------- */
async function ensureSeed(){
  const snap = await playersCol.limit(1).get();
  if (snap.empty){
    await seedPlayers();
  } else {
    await loadPlayers();
  }
}

/* ---------- addToUser helper defined earlier ---------- */

/* ---------- initial boot ---------- */
buildAuthArea();
ensureSeed();
loadPlayers();
renderPool();

/* auth state reaction */
auth.onAuthStateChanged(user=>{
  if (user) {
    // nothing: buildAuthArea() shows sign out; renderAll will run via listeners
  } else {
    // not signed in: clear pitch etc
    gkRow.innerHTML=''; defRow.innerHTML=''; midRow.innerHTML=''; fwdRow.innerHTML=''; benchEl.innerHTML=''; poolEl.innerHTML='';
  }
});

/* search/filter events */
searchEl.addEventListener('input', renderPool);
filterEl.addEventListener('change', renderPool);

/* sync button */
document.getElementById('btnSyncPlayers').addEventListener('click', ()=> {
  if (!auth.currentUser || !ADMIN_EMAILS.includes((auth.currentUser.email||'').toLowerCase())) return alert('Admin only');
  seedPlayers();
});

/* recalc button */
document.getElementById('btnRecalc').addEventListener('click', ()=> {
  if (!auth.currentUser || !ADMIN_EMAILS.includes((auth.currentUser.email||'').toLowerCase())) return alert('Admin only');
  recalcAllUserTotals();
});

/* helper: addToUser & removeFromUser exposed to window for inline onclick from HTML strings */
window.addToUser = addToUser;
window.removeFromUser = removeFromUser;

</script>
</body>
</html>
